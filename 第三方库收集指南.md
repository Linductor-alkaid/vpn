# SDUVPN 第三方库收集指南

## 项目结构设置

首先创建项目目录结构：

```
sduvpn/
├── src/                    # 源代码
├── include/               # 头文件
├── third_party/          # 第三方库目录
│   ├── json/             # JSON解析库
│   ├── spdlog/           # 日志库
│   ├── googletest/       # 测试框架
│   ├── asio/             # 网络库
│   └── crypto/           # 自研加密库
├── cmake/                # CMake模块
├── build/                # 构建目录
├── config/               # 配置文件
└── docs/                 # 文档
```

## 需要收集的第三方库

### 1. JSON解析库 - nlohmann/json
- **项目地址**: https://github.com/nlohmann/json
- **版本**: v3.11.2 (最新稳定版)
- **用途**: 配置文件解析、协议消息序列化
- **集成方式**: Header-only库，直接包含头文件

**下载方式**:
```bash
git clone https://github.com/nlohmann/json.git third_party/json
cd third_party/json
git checkout v3.11.2
```

### 2. 日志库 - spdlog
- **项目地址**: https://github.com/gabime/spdlog
- **版本**: v1.12.0
- **用途**: 系统日志记录
- **集成方式**: Header-only或编译为静态库

**下载方式**:
```bash
git clone https://github.com/gabime/spdlog.git third_party/spdlog
cd third_party/spdlog
git checkout v1.12.0
```

### 3. 测试框架 - GoogleTest
- **项目地址**: https://github.com/google/googletest
- **版本**: v1.14.0
- **用途**: 单元测试和集成测试
- **集成方式**: 编译为静态库

**下载方式**:
```bash
git clone https://github.com/google/googletest.git third_party/googletest
cd third_party/googletest
git checkout v1.14.0
```

### 4. 网络库 - Asio (Standalone)
- **项目地址**: https://github.com/chriskohlhoff/asio
- **版本**: asio-1-28-0
- **用途**: 异步网络I/O
- **集成方式**: Header-only库
- **优势**: 无需Boost依赖，更轻量级

**下载方式**:
```bash
git clone https://github.com/chriskohlhoff/asio.git third_party/asio
cd third_party/asio
git checkout asio-1-28-0
```

### 5. 跨平台线程库 - cpp11-on-multicore (可选)
- **项目地址**: https://github.com/preshing/cpp11-on-multicore
- **用途**: 无锁编程和原子操作示例
- **集成方式**: 参考代码

## 自研加密库设计

由于您提到OpenSSL在Windows Git环境下有问题，我们将开发一个轻量级的加密库：

### 加密算法选择

1. **对称加密**: AES-256-GCM
   - 提供加密和认证
   - 性能优秀
   - 安全性高

2. **哈希算法**: SHA-256
   - 用于数据完整性校验
   - 密钥派生

3. **密钥交换**: ECDH (Elliptic Curve Diffie-Hellman)
   - 基于椭圆曲线的密钥交换
   - 比传统DH更高效

4. **随机数生成**: 系统随机数API
   - Windows: CryptGenRandom
   - Linux: /dev/urandom

### 自研加密库结构

```cpp
// crypto/include/crypto.h
namespace sduvpn {
namespace crypto {

class AES256GCM {
public:
    static constexpr size_t KEY_SIZE = 32;
    static constexpr size_t IV_SIZE = 12;
    static constexpr size_t TAG_SIZE = 16;
    
    bool encrypt(const uint8_t* key, const uint8_t* iv,
                const uint8_t* plaintext, size_t plaintext_len,
                uint8_t* ciphertext, uint8_t* tag);
    
    bool decrypt(const uint8_t* key, const uint8_t* iv,
                const uint8_t* ciphertext, size_t ciphertext_len,
                const uint8_t* tag, uint8_t* plaintext);
};

class SHA256 {
public:
    static constexpr size_t HASH_SIZE = 32;
    
    void hash(const uint8_t* data, size_t len, uint8_t* output);
    void hmac(const uint8_t* key, size_t key_len,
              const uint8_t* data, size_t data_len,
              uint8_t* output);
};

class ECDH {
public:
    static constexpr size_t PRIVATE_KEY_SIZE = 32;
    static constexpr size_t PUBLIC_KEY_SIZE = 64;
    static constexpr size_t SHARED_SECRET_SIZE = 32;
    
    bool generateKeyPair(uint8_t* private_key, uint8_t* public_key);
    bool computeSharedSecret(const uint8_t* private_key,
                            const uint8_t* peer_public_key,
                            uint8_t* shared_secret);
};

class SecureRandom {
public:
    static bool generate(uint8_t* buffer, size_t size);
};

} // namespace crypto
} // namespace sduvpn
```

## CMake配置文件

创建 `cmake/ThirdParty.cmake`:

```cmake
# 第三方库配置

# JSON库 (Header-only)
set(JSON_INCLUDE_DIR ${CMAKE_SOURCE_DIR}/third_party/json/single_include)

# spdlog库
set(SPDLOG_INCLUDE_DIR ${CMAKE_SOURCE_DIR}/third_party/spdlog/include)
option(SPDLOG_BUILD_SHARED "" OFF)
add_subdirectory(third_party/spdlog)

# GoogleTest
option(BUILD_GMOCK "" OFF)
option(INSTALL_GTEST "" OFF)
add_subdirectory(third_party/googletest)

# Asio库 (Header-only)
set(ASIO_INCLUDE_DIR ${CMAKE_SOURCE_DIR}/third_party/asio/asio/include)
add_definitions(-DASIO_STANDALONE)
add_definitions(-DASIO_NO_DEPRECATED)

# 设置包含目录
set(THIRD_PARTY_INCLUDE_DIRS
    ${JSON_INCLUDE_DIR}
    ${SPDLOG_INCLUDE_DIR}
    ${ASIO_INCLUDE_DIR}
    PARENT_SCOPE
)

# 设置链接库
set(THIRD_PARTY_LIBRARIES
    spdlog::spdlog
    PARENT_SCOPE
)

# 测试库
set(TEST_LIBRARIES
    gtest
    gtest_main
    PARENT_SCOPE
)
```

## 平台特定依赖

### Windows平台
- **TAP-Windows驱动**: 
  - 下载地址: https://build.openvpn.net/downloads/releases/
  - 文件: `tap-windows-9.24.2-I601-Win10.exe`
  - 用途: 虚拟网卡驱动

### Android平台
- **Android NDK**: 通过Android Studio安装
- **CMake for Android**: 通过Android Studio安装

## 库文件下载脚本

创建 `scripts/setup_dependencies.bat` (Windows):

```batch
@echo off
echo 正在设置第三方依赖...

cd /d "%~dp0.."

echo 创建third_party目录...
if not exist third_party mkdir third_party
cd third_party

echo 下载nlohmann/json...
git clone https://github.com/nlohmann/json.git json
cd json
git checkout v3.11.2
cd ..

echo 下载spdlog...
git clone https://github.com/gabime/spdlog.git spdlog
cd spdlog
git checkout v1.12.0
cd ..

echo 下载GoogleTest...
git clone https://github.com/google/googletest.git googletest
cd googletest
git checkout v1.14.0
cd ..

echo 下载Asio...
git clone https://github.com/chriskohlhoff/asio.git asio
cd asio
git checkout asio-1-28-0
cd ..

echo 第三方库下载完成！
pause
```

创建 `scripts/setup_dependencies.sh` (Linux):

```bash
#!/bin/bash
echo "正在设置第三方依赖..."

cd "$(dirname "$0")/.."

echo "创建third_party目录..."
mkdir -p third_party
cd third_party

echo "下载nlohmann/json..."
git clone https://github.com/nlohmann/json.git json
cd json
git checkout v3.11.2
cd ..

echo "下载spdlog..."
git clone https://github.com/gabime/spdlog.git spdlog
cd spdlog
git checkout v1.12.0
cd ..

echo "下载GoogleTest..."
git clone https://github.com/google/googletest.git googletest
cd googletest
git checkout v1.14.0
cd ..

echo "下载Asio..."
git clone https://github.com/chriskohlhoff/asio.git asio
cd asio
git checkout asio-1-28-0
cd ..

echo "第三方库下载完成！"
```

## 下载顺序建议

1. 首先运行对应平台的依赖下载脚本
2. 验证所有库都下载成功
3. 运行CMake配置测试
4. 开始开发自研加密库

## 注意事项

1. **网络问题**: 如果GitHub访问较慢，可以使用国内镜像或下载release包
2. **版本兼容**: 建议使用指定版本避免兼容性问题
3. **编译选项**: 确保所有库使用相同的编译器和标准
4. **许可证**: 注意各库的许可证要求

---

请按照以上指南下载相关库文件，完成后我们就可以开始项目的具体实现了！
